<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smile WiFi News</title>
  <style>
    body{font-family:Arial,sans-serif;background:#f9f9f9;margin:0;padding:0;text-align:center}
    header{background:#2c3e50;color:#fff;padding:20px}
    h1{margin:0}
    article{margin:20px auto;max-width:800px;background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.1)}
    img{max-width:100%;height:auto;border-radius:4px}
    footer{background:#2c3e50;color:#fff;padding:10px;position:fixed;width:100%;bottom:0}
    .error{background:#ffe6e6;color:#d00;padding:15px;border-radius:8px;margin:20px;font-family:monospace}
  </style>
</head>
<body>
  <header><h1>Smile WiFi News</h1></header>
  <main id="news-list"><p>Loading news…</p></main>
  <footer><p>© 2025 Smile WiFi</p></footer>

  <!-- SUPABASE UMD (Global) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = 'https://fhmeepsbofuxktpztfmp.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZobWVlcHNib2Z1eGt0cHp0Zm1wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwMzcyMTYsImV4cCI6MjA3ODYxMzIxNn0.dDsgqlmHUB_gcEbsqAZ77ebCtBwyeaIDCLiKsiyOiTA';

    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);  // Note: lowercase 'supabase'

    async function loadNews() {
      try {
        const { data, error } = await supabase
          .from('news')
          .select('*')
          .order('date', { ascending: false });

        if (error) throw error;

        const container = document.getElementById('news-list');
        container.innerHTML = data.length
          ? data.map(a => `
              <article>
                <h2>${a.title}</h2>
                <time>${new Date(a.date).toLocaleDateString()}</time>
                ${a.image ? `<img src="${SUPABASE_URL}/storage/v1/object/public/news-images/${a.image}" alt="News image">` : ''}
                <div style="text-align:left;margin-top:10px;">${marked.parse(a.body)}</div>
              </article>`).join('')
          : '<p>No news yet. <a href="/admin/index.html">Add one in Admin</a></p>';  // Fixed path for new repo
      } catch (err) {
        console.error(err);
        document.getElementById('news-list').innerHTML = `
          <div class="error">
            <strong>Supabase Error:</strong> ${err.message}<br><br>
            <small>1. Table <code>news</code> exists?<br>
            2. RLS policy "public read" enabled?<br>
            3. Bucket <code>news-images</code> is public?</small>
          </div>`;
      }
    }

    // Load markdown renderer
    const ms = document.createElement('script');
    ms.src = 'https://cdn.jsdelivr.net/npm/marked@14/marked.min.js';  // Latest version
    ms.onload = loadNews;
    ms.onerror = () => document.getElementById('news-list').innerHTML = '<p style="color:red;">Failed to load Markdown.</p>';
    document.head.appendChild(ms);
  </script>
</body>
</html>
